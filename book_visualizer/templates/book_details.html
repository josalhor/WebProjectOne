{% extends "base.html" %}
{% load static %}
{% load times_tag %}


{% block content %}
<section class="jumbotron">
	<div class="container">
		<h1 style='font-weight: bold;'>NYT BESTSELLERS</h1>
	</div>
</section>
<div class="container">
	<div class="row">
	</div>
</div>
<div class="container">
    <script src="{% static 'book_ajax.js' %}"></script>
    <div class="row">
        <!-- Image -->
        <div class="col-12 col-lg-6">
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <img class="card-img-top" style="height:420px;object-fit: contain" id="book-thumb" src="{% static 'stock_temp.jpg' %}"/>
                </div>
            </div>
        </div>

        <!-- Add to cart -->
        <div class="col-12 col-lg-6 add_to_cart_block">
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h2 class="card-text">{{ book.title }}</h2>
                    <h4 class="card-text">Written by: <span style="color: grey;">{{ book.author }}</span></h4>
                    <br></br>
                    <h5 class="card-text">ISBN: <span style="color: grey;">{{ book.isbn }}</span> </h5>
                    <h5 class="card-text">Last time best seller: <span style="color: grey;">{{ book.bestsellers_date }}</span></h5>
                    <h5 class="card-text">Publisher: <span style="color: grey;">{{ book.publisher }}</span></h5>
                    <h5 id="price" class="card-text">Price: <span style="color: grey;">Price no available</span></h5>
                    <br></br>
                    <form method="get" action="wish_list.html">
                        <a id="list_ref" href="#" class="btn btn-success btn-lg btn-block text-uppercase" onclick="addToWishList()">
                            <i class="fa fa-gift"></i> Add to my wish list
                        </a>
                    </form>
                    <div class="reviews_product p-3 mb-2 ">
                        {% if num_comments == 1 %}
                            {{ num_comments }} review
                        {% endif %}
                        {% if num_comments == 0 or num_comments > 1 %}
                            {{ num_comments }} reviews
                        {% endif %}
                        {% for item in num_stars|add:"0"|times %}
                            <i class="fa fa-star"></i>
                        {% endfor %}
                        {% if num_comments > 0 %}
                            ({{ average }}/5.0)
                            <a class="pull-right" href="#reviews">View all reviews</a>
                        {% endif %}
                        {% if num_comments == 0 %}
                            <a class="pull-right" href="#reviews">Write the first review</a>
                        {% endif %}
                        <script>
                            setBookDetails($('#book-thumb'), $('#price'), "{{book.isbn}}");
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Description -->
        <div class="col-12">
            <div class="card border-light mb-3">
                <div class="card-header bg-primary text-white text-uppercase"><i class="fa fa-align-justify"></i> SUMMARY</div>
                <div class="card-body">
                    <p class="card-text">{{ book.summary }}</p>
                </div>
            </div>
        </div>

        <!-- Reviews -->
        <div class="col-12" id="reviews">
            <div class="card border-light mb-3">
                <div class="card-header bg-primary text-white text-uppercase"><i class="fa fa-comment"></i> Reviews</div>
                <div class="card-body">
                    <!-- Add a comment -->
                    <div class="card border-0">
                        <!--Setting up the add new comment button that will be used for collapsing-->
                        <div class="card border-0" style="display:inline-block;">
                            <button id="addCommentButton" class="btn btn-success pull-right" type="button" onclick="addComment()">
                                Add new comment
                            </button>
                            <h6 id="num_comments" ></h6>
                        </div>
                        <div id="divComment" style="display:none;">
                            <hr class="my-2">
                            <div class="card card-body border-0">
                                <h4>Leave a comment</h4>
                                <div class="form-group stars">
                                    <span class="rate required">
                                        <a class="star-1" id="star-1" onClick="starsRate(1)">1</a>
                                        <a class="star-2" id="star-2" onClick="starsRate(2)">2</a>
                                        <a class="star-3" id="star-3" onClick="starsRate(3)">3</a>
                                        <a class="star-4" id="star-4" onClick="starsRate(4)">4</a>
                                        <a class="star-5" id="star-5" onClick="starsRate(5)">5</a>
                                    </span>
                                </div>
                                <script src="{% static 'stars.js' %}"></script>
                                <form id="comment_form" onsubmit="return sendComment(this)" class="was-validated">
                                    <div class="col-md-12 mb-3">
                                        <label for="title">Title:</label>
                                        <input name="title" type="text" minlength="5" maxlength="150" class="form-control" id="title" placeholder="Write a useful title for your comment" required>
                                        <div class="invalid-feedback">
                                            Length must be between 5 and 150 characters
                                        </div>
                                        </div>
                                        <div class="col-md-12 mb-3">
                                        <label for="body">Comment:</label>
                                        <textarea name="body" type="text" minlength="10" maxlength="500" class="form-control" id="body" placeholder="Write a comment to the book" required></textarea>
                                        <div class="invalid-feedback">
                                            Length must be between 10 and 500 characters
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary" id="submitButton">Submit</button>
                                    <button id="cancel" class="btn btn-secondary" style="display:none;">Cancel</button>
                                </form>
                                <hr class="my-2">
                            </div>
                        </div>
                    </div>
                    <!-- Show comments -->
                    <div class="card border-0">
                        {% for comment in comments %}
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-1">
                                        <img src="https://image.ibb.co/jw55Ex/def_face.jpg" class="img img-rounded img-fluid"/>
                                        <p class="text-secondary text-center" style="font-size: 10px;">{{ comment.date }}</p>
                                    </div>
                                    <div class="col-md-11" id="comment-{{ comment.made_by }}">
                                        <p style="display: inline-block;"><strong>{{ comment.title }}</strong> by {{ comment.made_by }} &nbsp</p>
                                        {% for item in comment.stars|add:"0"|times %}
                                        <span><i class="text-warning fa fa-star"></i></span>
                                        {% endfor %} 
                                        {% if user == comment.made_by %}
                                            <button class="float-right btn btn-success btn-sm rounded-5" type="button" title="Edit" onclick="editComment('{{comment.stars}}')"><i class="fa fa-edit"></i></button>
                                            <!--<button class="float-right btn btn-danger btn-sm rounded-5" type="button"title="Delete" onclick="deleteComment()"><i class="fa fa-trash"></i></button>-->
                                        {% endif %}
                                        <p id="comment-body-{{ comment.made_by }}">{{ comment.body }}</p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div> 
    </div>
</div>
<script>
    var stars = 0;
    var stars_comment = 0;
    var num_comments = '{{ num_comments }}';
    var num_comments_user = '{{ num_comments_user }}';
    if(num_comments == 1){
        document.getElementById('num_comments').value = num_comments + "review";
    }else{
        document.getElementById('num_comments').value = num_comments + "reviews";
    }
    if (num_comments_user == 1){
        $("#addCommentButton").hide();
    }

    function starsRate(clicked_id){
        stars = clicked_id;
    }

    function sendComment(form){
        var sent;
        if(!([1,2,3,4,5].includes(stars))){
            swal({title: "Please, give a rate before submiting"});
            event.preventDefault();
        }else{
            comment_data = new Object();
            comment_data.title = form.elements["title"].value;
            comment_data.body = form.elements["body"].value;
            comment_data. stars = stars.toString();
            comment_data.based_on = '{{ book.isbn }}';

            var comment = JSON.parse(JSON.stringify(comment_data));
            var onSuccess = function () {
                swal({   
                    title: "Greeeat",   
                    text: "Thank you :)",   
                    icon: "success",
                    buttons: false,
                });
                $("#addCommentButton").hide();
                num_comments += 1;
            }
            var onFail = function () {
                swal({   
                    title: "Oops",   
                    text: "Something went wrong! Please try it again later.",   
                    icon: "warning",
                });
            }
            postComment(comment, onSuccess, onFail);
        }
    }

    function addComment() {
        if("{{ request.user.is_authenticated }}" == "True" && "{{ num_comments_user }}" == 0){
            document.getElementById('divComment').style.display = "block";
        }else if ("{{ num_comments_user }}" != 0){
            swal({  
                text: "Sorry, you already have a comment on this book",   
            });
        }else{
            window.location.href = '/login';
        }
    }

    function addToWishList() {
        if("{{ request.user.is_authenticated }}" == "True" && '{{ added_book }}' == "False"){
            var onSuccess = function () {
                document.getElementById('list_ref').getAttributeNode("href").value = "{% url 'wish_list' user %}";
                document.getElementById('list_ref').click();
            }
            var onFail = function () {
                swal({   
                    title: "Oops",   
                    text: "Something went wrong! Please try it again later.",   
                    icon: "warning",
                });
                document.getElementById('list_ref').getAttributeNode("href").value = "{% url 'wish_list' user %}";
                document.getElementById('list_ref').click();
            }
            var isbn = '{{ book.isbn }}';
            wishBook(isbn, onSuccess, onFail);
        }else if ('{{ added_book }}' == "True"){
            swal({  
                text: "This book is already in your wish list!",   
            });
        }else{
            window.location.href = '/login';
        }
    }

    function editComment(comment_stars) {
        var comment = $("#comment-{{ user }}");
        var title = comment.find("strong")[0].innerText;
        var body = $("#comment-body-{{ user }}")[0].innerText;
        var star_rate = "star-".concat(comment_stars.toString());
        document.getElementById('divComment').style.display = "block";
        document.getElementById('cancel').style.display = "inline-block";
        document.getElementById('divComment').focus();
        document.getElementById('title').value = title;
        document.getElementById('body').value = body;
        document.getElementById(star_rate.toString()).click();
        document.getElementById(star_rate).click();
    }
    function deleteComment() {
        //Delete element
        $("#addCommentButton").show();
    }

</script>
{% endblock content %}